#!/usr/bin/expect

set timeout 360


spawn $::env(KEYSTONE_DIR)/riscv-qemu/riscv64-softmmu/qemu-system-riscv64 \
		-m 4G \
		-bios $::env(KEYSTONE_DIR)/bootrom/bootrom.elf \
		-nographic \
		-machine virt \
		-kernel $::env(KEYSTONE_DIR)/hifive-work/riscv-pk/bbl \
		-netdev user,id=net0,net=192.168.100.1/24,dhcpstart=192.168.100.128,hostfwd=tcp::10032-:22 \
		-device virtio-net-device,netdev=net0

expect "ogin: "
send "root\r"

expect "assword: "
send "sifive\r"

send "PS1='##''## '\r"
expect "#### "

send "insmod keystone-driver.ko || echo 'err''or'\r"
expect {
	"error" { exit 1 }
	"#### "
}

send "cd /root/teep-device\r"
expect "#### "

send -- "ls -l\r"
expect "#### "

send "./hello-app hello-ta eyrie-rt\r"
expect "hello TA"
expect "#### "

set err 0

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "file does not exist"
expect "#### "

send -- "./teep-broker-app --tamurl $::env(TAM_URL)/api/tam\r"
expect {
	-re " ERR:" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "ls -l\r"
expect "#### "

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "hello TA"
expect "#### "

send "cmp 8d82573a-926d-4754-9353-32dc29997f74.ta 8d82573a-926d-4754-9353-32dc29997f74.ta.secstor.plain\r"
expect {
	-re "differ" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "./teep-broker-app --tamurl $::env(TAM_URL)/api/tam_delete  --talist 8d82573a-926d-4754-9353-32dc29997f74\r"
expect {
	-re " ERR:" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "ls -l\r"
expect "#### "

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "file does not exist"
expect "#### "

send -- "./teep-broker-app --tamurl $::env(TAM_URL)/api/tam_jose --jose\r"
expect {
	-re " ERR:" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "ls -l\r"
expect "#### "

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "hello TA"
expect "#### "

send -- "./teep-broker-app --tamurl $::env(TAM_URL)/api/tam_jose_delete --jose --talist 8d82573a-926d-4754-9353-32dc29997f74\r"
expect {
	-re " ERR:" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "ls -l\r"
expect "#### "

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "file does not exist"
expect "#### "

puts " done\n"

exit $err
