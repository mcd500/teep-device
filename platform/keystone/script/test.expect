#!/usr/bin/expect

set timeout 360
set PORT $::env(PORT)
set USER $::env(USER)
set IP_ADDR $::env(IP_ADDR)
set PASSWD $::env(PASSWD)

spawn ssh $USER@$IP_ADDR -p $PORT
expect "?" {
    send "yes\r"
    expect "*?assword" {
        send "$PASSWD\r"
    }
}

expect "# " {
    send "insmod keystone-driver.ko; sleep 2; true\r"
}

expect "# " {
    send "cd /root/teep-device\r"
    send "./hello-app\r"
    expect "enclave.run\r" {} timeout {
        exit 1
    }
    expect "hello ta\r" {} timeout {
        exit 1
    }
}

expect "# " {
    send "ls -lsa .\r"
}

expect "# " {
    send "exit\r"
}

expect eof

exit
