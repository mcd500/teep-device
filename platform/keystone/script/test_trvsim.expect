#!/usr/bin/expect

set timeout 360

spawn sshpass -p "sifive" ssh -p $::env(PORT) -o "StrictHostKeyChecking no" root@trvsim

send "PS1='#### '\r"
expect "#### "

send "insmod keystone-driver.ko; sleep 2; true\r"
expect "#### "

send -- "ls -R\r"
expect "#### "

send "cd /root/teep-device\r"
expect "#### "

send -- "ls -l\r"
expect "#### "

send "./hello-app hello-ta eyrie-rt\r"
expect "hello TA"
expect "#### "

set err 0

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "file does not exist"
expect "#### "

send -- "./teep-broker-app --tamurl $::env(TAM_URL)/api/tam\r"
expect {
	-re " ERR:" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "ls -l\r"
expect "#### "

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "hello TA"
expect "#### "

send "cmp 8d82573a-926d-4754-9353-32dc29997f74.ta 8d82573a-926d-4754-9353-32dc29997f74.ta.secstor.plain\r"
expect {
	-re "differ" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "./teep-broker-app --tamurl $::env(TAM_URL)/api/tam_delete  --talist 8d82573a-926d-4754-9353-32dc29997f74\r"
expect {
	-re " ERR:" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "ls -l\r"
expect "#### "

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "file does not exist"
expect "#### "

send -- "./teep-broker-app --tamurl $::env(TAM_URL)/api/tam_jose2 --jose\r"
expect {
	-re " ERR:" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "ls -l\r"
expect "#### "

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "hello TA"
expect "#### "

send -- "./teep-broker-app --tamurl $::env(TAM_URL)/api/tam_jose2_delete --jose --talist 8d82573a-926d-4754-9353-32dc29997f74\r"
expect {
	-re " ERR:" { set err 1 }
	timeout { exit 1 }
	"#### "
}

send -- "ls -l\r"
expect "#### "

send "./hello-app 8d82573a-926d-4754-9353-32dc29997f74.ta eyrie-rt\r"
expect "file does not exist"
expect "#### "

puts " done\n"

exit $err
